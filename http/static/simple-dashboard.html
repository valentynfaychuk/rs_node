<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amadeus Node Dashboard - Simple</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: #0f1419;
            color: #ffffff;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { color: #00d4ff; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #8e8e93; margin-bottom: 30px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { 
            background: #1e1e1e; 
            border-radius: 12px; 
            padding: 20px; 
            border: 1px solid #333;
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        .card:hover { transform: translateY(-2px); }
        
        .card h3 { color: #00d4ff; margin-bottom: 15px; font-size: 1.1rem; }
        .metric { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .metric:last-child { margin-bottom: 0; }
        .metric-label { color: #8e8e93; }
        .metric-value { color: #ffffff; font-weight: 600; }
        
        .status { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status.online { background: #00d4ff20; color: #00d4ff; }
        .status.error { background: #ff453520; color: #ff4535; }
        
        .loading { text-align: center; color: #8e8e93; }
        .refresh-btn {
            background: #00d4ff;
            color: #0f1419;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 20px auto;
            display: block;
        }
        .refresh-btn:hover { background: #0099cc; }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Amadeus Node Dashboard</h1>
        <p class="subtitle">Real-time blockchain network monitoring</p>
        
        <div class="grid" id="dashboard">
            <div class="loading">Loading dashboard data...</div>
        </div>
        
        <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
    </div>

    <script>
        let metricsData = {};
        let peersData = {};

        async function loadData() {
            try {
                console.log('Loading dashboard data...');
                
                const [metricsRes, peersRes] = await Promise.all([
                    fetch('/metrics/json').catch(e => ({ ok: false, error: e })),
                    fetch('/peers/json').catch(e => ({ ok: false, error: e }))
                ]);

                if (metricsRes.ok) {
                    metricsData = await metricsRes.json();
                    console.log('Metrics loaded:', metricsData);
                } else {
                    console.warn('Failed to load metrics:', metricsRes.error || 'Unknown error');
                }

                if (peersRes.ok) {
                    peersData = await peersRes.json();
                    console.log('Peers loaded:', peersData);
                } else {
                    console.warn('Failed to load peers:', peersRes.error || 'Unknown error');
                }

                renderDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dashboard').innerHTML = `
                    <div class="card">
                        <h3>‚ö†Ô∏è Connection Error</h3>
                        <p style="color: #ff4535;">Unable to load dashboard data. Please check if the node is running.</p>
                    </div>
                `;
            }
        }

        function renderDashboard() {
            const totalMessages = Object.values(metricsData.handled_protos || {}).reduce((a, b) => a + b, 0);
            const totalErrors = Object.values(metricsData.errors || {}).reduce((a, b) => a + b, 0);
            const peerCount = Object.keys(peersData || {}).length;
            
            // Enhanced uptime calculation with debugging
            const uptimeSeconds = metricsData.uptime || 0;
            console.log('Raw uptime seconds:', uptimeSeconds);
            
            const uptimeDays = Math.floor(uptimeSeconds / 86400);
            const uptimeHours = Math.floor((uptimeSeconds % 86400) / 3600);
            const uptimeMinutes = Math.floor((uptimeSeconds % 3600) / 60);
            const uptimeSecondsRemainder = Math.floor(uptimeSeconds % 60);
            
            console.log('Calculated uptime:', { days: uptimeDays, hours: uptimeHours, minutes: uptimeMinutes, seconds: uptimeSecondsRemainder });
            
            // Format uptime string
            let uptimeString = '';
            if (uptimeDays > 0) {
                uptimeString += `${uptimeDays}d `;
            }
            if (uptimeHours > 0 || uptimeDays > 0) {
                uptimeString += `${uptimeHours}h `;
            }
            if (uptimeMinutes > 0 || uptimeHours > 0 || uptimeDays > 0) {
                uptimeString += `${uptimeMinutes}m`;
            }
            if (uptimeString === '') {
                uptimeString = `${uptimeSecondsRemainder}s`;
            }
            
            console.log('Final uptime string:', uptimeString);

            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="card" onclick="window.location.href='/metrics'">
                    <h3>üìä Network Statistics</h3>
                    <div class="metric">
                        <span class="metric-label">Total Messages:</span>
                        <span class="metric-value">${totalMessages.toLocaleString()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Bytes Received:</span>
                        <span class="metric-value">${((metricsData.packets?.total_incoming_bytes || 0) / 1024).toFixed(1)} KB</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Packets Received:</span>
                        <span class="metric-value">${(metricsData.packets?.total_incoming_packets || 0).toLocaleString()}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Packets/sec:</span>
                        <span class="metric-value">${metricsData.packets?.packets_per_second || 0}</span>
                    </div>
                </div>

                <div class="card" onclick="window.location.href='/peers'">
                    <h3>üë• Network Peers</h3>
                    <div class="metric">
                        <span class="metric-label">Connected Peers:</span>
                        <span class="metric-value">${peerCount}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Status:</span>
                        <span class="status online">Online</span>
                    </div>
                </div>

                <div class="card" onclick="window.location.href='/metrics'">
                    <h3>‚è±Ô∏è System Status</h3>
                    <div class="metric">
                        <span class="metric-label">Uptime:</span>
                        <span class="metric-value">${uptimeString || '0s'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Errors:</span>
                        <span class="metric-value ${totalErrors > 0 ? 'status error' : ''}">${totalErrors}</span>
                    </div>
                </div>

                ${Object.keys(metricsData.handled_protos || {}).length > 0 ? `
                <div class="card" onclick="window.location.href='/metrics'">
                    <h3>üìù Protocol Messages</h3>
                    ${Object.entries(metricsData.handled_protos).map(([proto, count]) => `
                        <div class="metric">
                            <span class="metric-label">${proto}:</span>
                            <span class="metric-value">${count.toLocaleString()}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${Object.keys(metricsData.errors || {}).length > 0 ? `
                <div class="card" onclick="window.location.href='/metrics'">
                    <h3>‚ö†Ô∏è Recent Errors</h3>
                    ${Object.entries(metricsData.errors).map(([errorType, count]) => `
                        <div class="metric">
                            <span class="metric-label">${errorType}:</span>
                            <span class="metric-value status error">${count}</span>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                ${Object.keys(peersData || {}).length > 0 ? `
                <div class="card" onclick="window.location.href='/peers'">
                    <h3>üåê Peer Details</h3>
                    ${Object.entries(peersData).slice(0, 5).map(([addr, info]) => `
                        <div class="metric">
                            <span class="metric-label">${addr}:</span>
                            <span class="metric-value">${info.last_msg || 'N/A'}</span>
                        </div>
                    `).join('')}
                    ${Object.keys(peersData).length > 5 ? 
                        `<div class="metric"><span class="metric-label">...</span><span class="metric-value">+${Object.keys(peersData).length - 5} more</span></div>` 
                        : ''}
                </div>
                ` : ''}
            `;
        }

        // Load data on page load
        loadData();
        
        // Auto-refresh every 1 second
        setInterval(loadData, 1000);
    </script>
</body>
</html>